image:
    - Visual Studio 2019
    - Ubuntu
    - macOS

branches:
    except:
        - gh-pages

for:
-
  matrix:
    only:
      - image: Visual Studio 2019

  environment:
      QTDIR: C:\Qt\5.15.2\mingw81_64

  install:
      - set PATH=%QTDIR%\bin;%PATH%
      - git submodule update --init --recursive

  before_build:
      - mkdir lmdb
      - cd lmdb
      - curl -O https://mirror.msys2.org/mingw/mingw64/mingw-w64-x86_64-lmdb-0.9.27-1-any.pkg.tar.zst
      - C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\bin\zstd.exe -d ./mingw-w64-x86_64-lmdb-0.9.27-1-any.pkg.tar.zst
      - tar -xvf ./mingw-w64-x86_64-lmdb-0.9.27-1-any.pkg.tar
      - cd ..
      - mkdir build
      - cd build
      - cmake -GNinja -DCMAKE_BUILD_TYPE:String=Release -DCMAKE_PREFIX_PATH:STRING=%QTDIR% -DLMDB_DIR:PATH=../lmdb/mingw64 ..

  build_script:
      - cmake --build .
      - mkdir deploy
      - cd deploy
      - copy ../squawk.exe ./
      - copy ../external/qxmpp/src/libqxmpp.dll ./
      - windeployqt ./squawk.exe
      - windeployqt ./libqxmpp.dll
      - cd ../..

  artifacts:
      - path: build/deploy/squawk.exe
        name: Squawk executable (Qt 5.15.2)

      - path: build/deploy
        name: Squawk deployment
    
-
  matrix:
    only:
      - image: macOS

  install:
      - brew install lmdb
      - git submodule update --init --recursive

  before_build:
      - mkdir build
      - cd build
      - cmake -DCMAKE_BUILD_TYPE:String=Release -DCMAKE_PREFIX_PATH:STRING=$HOME/Qt/5.15.2/clang_64 -DLMDB_DIR:PATH=/usr/local/opt/lmdb ..

  build_script:
      - cmake --build .

  artifacts:
      - path: build/squawk
        name: Squawk executable (Qt 5.15.2)

-
  matrix:
    only:
      - image: Ubuntu

  install:
      - sudo apt install -y liblmdb-dev liblmdb0
      - git submodule update --init --recursive

  before_build:
      - mkdir build
      - cd build
      - cmake -DCMAKE_BUILD_TYPE:String=Release -DCMAKE_PREFIX_PATH:STRING=$HOME/Qt/5.15.2/gcc_64 -DLMDB_DIR:PATH=/usr/ ..

  build_script:
      - cmake --build .

  artifacts:
      - path: build/squawk.exe
        name: Squawk executable (Qt 5.15.2)
